from typing import Optional
import os
import requests
import json

# í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ì§ì ‘ ì„¤ì •
DEEPSEEK_API_KEY = os.environ.get("DEEPSEEK_API_KEY", "sk-c9d6142f97294961bcfceb7a5e0da3c9")

# ì´ˆë“±í•™ìƒì„ ìœ„í•œ ì˜ì–´ ì„ ìƒë‹˜ í”„ë¡¬í”„íŠ¸
TEACHER_PROMPT = """ë„ˆëŠ” ì˜ì–´ë¥¼ ê°€ë¥´ì¹˜ëŠ” ì´ˆë“±í•™ìƒ 1í•™ë…„ ì„ ìƒë‹˜ì´ì•¼. ë‹¤ìŒ ì§€ì¹¨ì„ ë”°ë¼ì£¼ì„¸ìš”:

1. ì•„ì´ë“¤ì—ê²Œ ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì£¼ì„¸ìš”.
2. ìµœëŒ€í•œ ì‰¬ìš´ ë‹¨ì–´ì™€ ì§§ì€ ë¬¸ì¥ì„ ì‚¬ìš©í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.
3. ë‹µë³€ì€ ê°€ëŠ¥í•˜ë©´ 20ë‹¨ì–´ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ê°„ê²°í•˜ê²Œ í•´ì£¼ê³  ë‘ ë¬¸ì¥ ì´ìƒì€ ë‹µë³€í•˜ì§€ë§ˆì„¸ìš”.
4. ì•„ì´ê°€ ì˜ëª»ëœ ë‹¨ì–´ë‚˜ ë°œìŒì„ ì‚¬ìš©í•˜ë©´ ë¶€ë“œëŸ½ê²Œ êµì •í•´ì£¼ì„¸ìš”.
5. ì–´ë ¤ìš´ ë‹¨ì–´ê°€ ë‚˜ì˜¤ë©´ ê°„ë‹¨í•œ ì„¤ëª…ì´ë‚˜ ì˜ˆì‹œë¥¼ í•¨ê»˜ ì•Œë ¤ì£¼ì„¸ìš”.
6. ì•„ì´ë“¤ì´ ì§ˆë¬¸í•  ë•ŒëŠ” ì¸ë‚´ì‹¬ì„ ê°€ì§€ê³  ê²©ë ¤í•˜ë©° ëŒ€ë‹µí•´ì£¼ì„¸ìš”.
7. ì˜ì–´ í•™ìŠµì— ì¬ë¯¸ë¥¼ ëŠë‚„ ìˆ˜ ìˆë„ë¡ ê¸ì •ì ì¸ í”¼ë“œë°±ì„ ì£¼ì„¸ìš”.
8. ì´ëª¨í‹°ì½˜ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. (ì˜ˆ: ğŸ˜Š, ğŸ‘, â­)
9. í­ë ¥ì ì´ê±°ë‚˜ ë¶€ì ì ˆí•œ ë‚´ìš©ì— ê´€í•œ ì§ˆë¬¸ì€ ë‹¤ë¥¸ ì£¼ì œë¡œ ë¶€ë“œëŸ½ê²Œ ì „í™˜í•´ì£¼ì„¸ìš”.
10. ëŒ€í™”ëŠ” ì˜ì–´ë¡œë§Œ ì§„í–‰í•´ì£¼ì„¸ìš”. (ì˜ˆ: "What is your name?" -> "My name is ...")

í•­ìƒ ì•„ì´ë“¤ì˜ í˜¸ê¸°ì‹¬ì„ ì¡´ì¤‘í•˜ê³  ë°°ì›€ì˜ ì¦ê±°ì›€ì„ ëŠë‚„ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”!"""


# ë„ˆëŠ” ì˜ì–´ë¥¼ ê°€ë¥´ì¹˜ëŠ” ì´ˆë“±í•™ìƒ 1í•™ë…„ ì„ ìƒë‹˜ì´ì•¼. ë‹¤ìŒ ì§€ì¹¨ì„ ë”°ë¼ì£¼ì„¸ìš”:

# 1. ì•„ì´ë“¤ì—ê²Œ ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì£¼ì„¸ìš”.
# 2. ìµœëŒ€í•œ ì‰¬ìš´ ë‹¨ì–´ì™€ ì§§ì€ ë¬¸ì¥ì„ ì‚¬ìš©í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.
# 3. ë‹µë³€ì€ ê°€ëŠ¥í•˜ë©´ 20ë‹¨ì–´ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ê°„ê²°í•˜ê²Œ í•´ì£¼ì„¸ìš”.
# 4. ì•„ì´ê°€ ì˜ëª»ëœ ë‹¨ì–´ë‚˜ ë°œìŒì„ ì‚¬ìš©í•˜ë©´ ë¶€ë“œëŸ½ê²Œ êµì •í•´ì£¼ì„¸ìš”.
# 5. ì–´ë ¤ìš´ ë‹¨ì–´ê°€ ë‚˜ì˜¤ë©´ ê°„ë‹¨í•œ ì„¤ëª…ì´ë‚˜ ì˜ˆì‹œë¥¼ í•¨ê»˜ ì•Œë ¤ì£¼ì„¸ìš”.
# 6. ì•„ì´ë“¤ì´ ì§ˆë¬¸í•  ë•ŒëŠ” ì¸ë‚´ì‹¬ì„ ê°€ì§€ê³  ê²©ë ¤í•˜ë©° ëŒ€ë‹µí•´ì£¼ì„¸ìš”.
# 7. ì˜ì–´ í•™ìŠµì— ì¬ë¯¸ë¥¼ ëŠë‚„ ìˆ˜ ìˆë„ë¡ ê¸ì •ì ì¸ í”¼ë“œë°±ì„ ì£¼ì„¸ìš”.
# 8. ì•„ì´ë“¤ì˜ ìˆ˜ì¤€ì— ë§ê²Œ ì‰¬ìš´ ì˜ì–´ í‘œí˜„ë¶€í„° ê°€ë¥´ì³ì£¼ì„¸ìš”.
# 9. ì´ëª¨í‹°ì½˜ì„ ì ì ˆíˆ ì‚¬ìš©í•´ ì¹œê·¼ê°ì„ ë†’ì—¬ì£¼ì„¸ìš”. (ì˜ˆ: ğŸ˜Š, ğŸ‘, â­)
# 10. í­ë ¥ì ì´ê±°ë‚˜ ë¶€ì ì ˆí•œ ë‚´ìš©ì— ê´€í•œ ì§ˆë¬¸ì€ ë‹¤ë¥¸ ì£¼ì œë¡œ ë¶€ë“œëŸ½ê²Œ ì „í™˜í•´ì£¼ì„¸ìš”.
# 11. ëŒ€í™”ëŠ” ì˜ì–´ë¡œë§Œ ì§„í–‰í•´ì£¼ì„¸ìš”. (ì˜ˆ: "What is your name?" -> "My name is ...")

# í•­ìƒ ì•„ì´ë“¤ì˜ í˜¸ê¸°ì‹¬ì„ ì¡´ì¤‘í•˜ê³  ë°°ì›€ì˜ ì¦ê±°ì›€ì„ ëŠë‚„ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”!


class EnglishTeacher:
    def __init__(self, api_key: str, system_prompt: str):
        self.api_key = api_key
        self.system_prompt = system_prompt
        self.api_url = "https://api.deepseek.com/v1/chat/completions"
        self.headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {api_key}"
        }
        
    def generate_response(self, user_input: str) -> str:
        """ì‚¬ìš©ì ì…ë ¥ì— ëŒ€í•œ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤."""
        try:
            payload = {
                "model": "deepseek-chat",  # Deepseekì˜ ì ì ˆí•œ ëª¨ë¸ëª…ìœ¼ë¡œ ëŒ€ì²´í•˜ì„¸ìš” (deepseek-chat, deepseek-coder ë“±)
                "messages": [
                    {"role": "system", "content": self.system_prompt},
                    {"role": "user", "content": user_input}
                ],
                "temperature": 0.7,  # ì°½ì˜ì„±ê³¼ ì¼ê´€ì„±ì˜ ê· í˜•ì„ ìœ„í•œ ì˜¨ë„ ì„¤ì •
                "max_tokens": 150,  # ì‘ë‹µ ê¸¸ì´ ì œí•œ
            }
            
            response = requests.post(self.api_url, headers=self.headers, json=payload)
            response.raise_for_status()  # HTTP ì˜¤ë¥˜ ë°œìƒ ì‹œ ì˜ˆì™¸ ë°œìƒ
            response_data = response.json()
            
            return response_data["choices"][0]["message"]["content"]
        except Exception as e:
            print(f"Error generating response: {e}")
            return "ì£„ì†¡í•´ìš”, ì§€ê¸ˆì€ ëŒ€ë‹µí•˜ê¸° ì–´ë ¤ì›Œìš”. ë‹¤ì‹œ ë¬¼ì–´ë´ ì£¼ì„¸ìš”. ğŸ˜Š"

# ë©”ì¸ í•¨ìˆ˜ - lessons.pyì—ì„œ í˜¸ì¶œë  í•¨ìˆ˜
def generate_response(text: str) -> str:
    """
    ì‚¬ìš©ì ì…ë ¥ì„ ë°›ì•„ AI ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
    lessons.pyì˜ chat í•¨ìˆ˜ì—ì„œ í˜¸ì¶œë©ë‹ˆë‹¤.
    """
    teacher = EnglishTeacher(DEEPSEEK_API_KEY, TEACHER_PROMPT)
    response = teacher.generate_response(text)
    return response

# ëª¨ë“ˆì´ ì§ì ‘ ì‹¤í–‰ë  ë•Œ í…ŒìŠ¤íŠ¸ìš© ì½”ë“œ
if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸ ì…ë ¥ ì˜ˆì‹œ
    test_inputs = [
        "Hello teacher, how are you?",
        "What is apple in English?",
        "I don't understand homework"
    ]
    
    teacher = EnglishTeacher(DEEPSEEK_API_KEY, TEACHER_PROMPT)
    
    for input_text in test_inputs:
        print(f"\nì‚¬ìš©ì: {input_text}")
        response = teacher.generate_response(input_text)
        print(f"ì„ ìƒë‹˜: {response}")